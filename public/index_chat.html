<!DOCTYPE html>
<html>
  <head>
    <title>Bootstrap 101 Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/index_chat.css" rel="stylesheet">
	<link href="css/nanoscroller.css" rel="stylesheet">	

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>


	<div class="chatSidebar">
		<div class="feedsContainer nano">
			<div class="content">
				<div class="feedContainer">
					<div class="row">
						<div class="col-xs-2 feed-img">
							<img class="" src="https://fbcdn-profile-a.akamaihd.net/hprofile-ak-prn2/s32x32/1119297_1239916588_1327344374_q.jpg" alt="">
						</div>
						<div class="col-xs-10">
							<span class="fwb">1</span> Notification
						</div>
					</div>
				</div>
				<div class="feedContainer">
					<div class="row">
						<div class="col-xs-2 feed-img">
							<img class="" src="https://fbcdn-profile-a.akamaihd.net/hprofile-ak-prn2/s32x32/1119297_1239916588_1327344374_q.jpg" alt="">
						</div>
						<div class="col-xs-10">
							<span class="fwb">2</span> Notification
						</div>
					</div>
				</div>
				<div class="feedContainer">
					<div class="row">
						<div class="col-xs-2 feed-img">
							<img class="" src="https://fbcdn-profile-a.akamaihd.net/hprofile-ak-prn2/s32x32/1119297_1239916588_1327344374_q.jpg" alt="">
						</div>
						<div class="col-xs-10">
							<span class="fwb">3</span> Notification
						</div>
					</div>
				</div>
				<div class="feedContainer">
					<div class="row">
						<div class="col-xs-2 feed-img">
							<img class="" src="https://fbcdn-profile-a.akamaihd.net/hprofile-ak-prn2/s32x32/1119297_1239916588_1327344374_q.jpg" alt="">
						</div>
						<div class="col-xs-10">
							<span class="fwb">4</span> Notification
						</div>
					</div>
				</div>
				<div class="feedContainer">
					<div class="row">
						<div class="col-xs-2 feed-img">
							<img class="" src="https://fbcdn-profile-a.akamaihd.net/hprofile-ak-prn2/s32x32/1119297_1239916588_1327344374_q.jpg" alt="">
						</div>
						<div class="col-xs-10">
							<span class="fwb">5</span> Notification
						</div>
					</div>
				</div>				
				<div class="feedContainer">
					<div class="row">
						<div class="col-xs-2 feed-img">
							<img class="" src="https://fbcdn-profile-a.akamaihd.net/hprofile-ak-prn2/s32x32/1119297_1239916588_1327344374_q.jpg" alt="">
						</div>
						<div class="col-xs-10">
							<span class="fwb">6</span> Notification
						</div>
					</div>
				</div>
				<div class="feedContainer">
					<div class="row">
						<div class="col-xs-2 feed-img">
							<img class="" src="https://fbcdn-profile-a.akamaihd.net/hprofile-ak-prn2/s32x32/1119297_1239916588_1327344374_q.jpg" alt="">
						</div>
						<div class="col-xs-10">
							<span class="fwb">7</span> Notification
						</div>
					</div>
				</div>
				<div class="feedContainer">
					<div class="row">
						<div class="col-xs-2 feed-img">
							<img class="" src="https://fbcdn-profile-a.akamaihd.net/hprofile-ak-prn2/s32x32/1119297_1239916588_1327344374_q.jpg" alt="">
						</div>
						<div class="col-xs-10">
							<span class="fwb">8</span> Notification
						</div>
					</div>
				</div>
				<div class="feedContainer">
					<div class="row">
						<div class="col-xs-2 feed-img">
							<img class="" src="https://fbcdn-profile-a.akamaihd.net/hprofile-ak-prn2/s32x32/1119297_1239916588_1327344374_q.jpg" alt="">
						</div>
						<div class="col-xs-10">
							<span class="fwb">9</span> Notification
						</div>
					</div>
				</div>		
			</div>
		</div>
		<div class="sidebarGripper" id="sidebarGripper"><div class="gripInner"><span class="gripNuclear"></span></div></div>

			<div class="chatContactsContainer nano" id="test">
				<div class="content">
						
				</div>
			</div>
	</div>	
    
	<div class="row chatBoxesContainer">
		
		<div class="col-xs-1 hiddenChatBoxes0 hidden">
			<div class="hiddenChatBoxes">
				<div class="row">
					<div class="listHiddenChatBoxes hidden">
						<div class="clearfix"></div>						
					</div>	
				</div>	
				<div class="row">
					<div class="numberHiddenChatBoxes border-top-visible">
						<a><i class="hiddenChatBoxesIcon"></i><span id='hiddenChatBoxesCounter'></span></a>
					</div>		
				</div>
			</div>
		</div>
		
	</div>

	
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) 
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://code.jquery.com/jquery.js"></script>-->
	<script src="js/jquery.js"></script>
	<script src="js/jquery-ui.js"></script>	
	<script src="js/jquery.nanoscroller.min.js"></script>	
    <script src="js/bootstrap.min.js"></script>
	
	<script src='/socket.io/socket.io.js' type='text/javascript'></script>
	<script src='/js/new_chat.js' type='text/javascript'></script>
	<script src='/js/new_chat_ui.js' type='text/javascript'></script>
	
	<script>	
		
		Array.prototype.insert = function (index, item) {
		  this.splice(index, 0, item);
		};
		
		window.onresize = function(event) {
			
			chat.global.maxNumberActiveChatBoxes = (Math.floor($(window).width()/300)-1);
			console.log('$(window).width()='+$(window).width());
			console.log('maxNumberActiveChatBoxes='+chat.global.maxNumberActiveChatBoxes);
			console.log('chat.global.activeChatBoxesArray.length='+chat.global.activeChatBoxesArray.length);
			
			while (chat.global.activeChatBoxesArray.length > chat.global.maxNumberActiveChatBoxes ){
				chat.hideLastActiveChatBox();
			}
			
			while (chat.global.activeChatBoxesArray.length < chat.global.maxNumberActiveChatBoxes && chat.global.hiddenChatBoxesArray.length){
						var tmpChatBoxId = chat.global.hiddenChatBoxesArray[chat.global.hiddenChatBoxesArray.length-1];	

						chat.removeFromHiddenList(tmpChatBoxId);
						
						chat.global.activeChatBoxesArray.push(tmpChatBoxId);
						
						$("#"+tmpChatBoxId).removeClass('hidden');
			}
		}
		
		
		var chat = (function() {
			return {
				path: '/',
				global: {
					maxNumberActiveChatBoxes : (Math.floor($(window).width()/300)-1),
					currentChatBox: 0,
					activeChatBoxesArray : new Array(),		
					hiddenChatBoxesArray : new Array(),							
				},
				createChatBox: function(chatNameId){
					var chatBox = "<div class='chatBox0' id='"+chatNameId+"-chatBox'>"+
									"<div class='chatBox expanded pull-right'> "+
									"							<div class=' chatTitlebar highlighted'>  "+
									"		<input class='chat-checkbox' type='checkbox' rel='"+chatNameId+"'/>			 "+
									"		<div class='col-xs-8'> "+
									"			<span class='titlebarIconLeft glyphicon glyphicon-phone white'></span> "+
									"			<a class='titlebarText' href='#' aria-level='3'>"+$('#'+chatNameId+'  .chatName').text()+"</a> "+
									"		</div>		"+
									"		<div class='col-xs-4 chatTitlebar-right'> "+
									"			<span id='"+chatNameId+"-closeButton' class='glyphicon glyphicon-remove white-f8 chatBoxCloseButton pull-right' data-toggle='tooltip' data-original-title='Close'></span> "+			
									"			<div class='dropdown'> "+
									"				  <span class='glyphicon glyphicon-wrench white-f8 pull-right  dropdown-toggle' id='dropdownMenu1' data-toggle='dropdown' data-toggle='tooltip' "+
									" data-original-title='Settings'></span> "+
									"				  <ul class='dropdown-menu' role='menu' aria-labelledby='dropdownMenu1'> "+
									"					<li role='presentation'><a role='menuitem' tabindex='-1' href='#'>Action</a></li> "+
									"					<li role='presentation'><a role='menuitem' tabindex='-1' href='#'>Another action</a></li> "+
									"					<li role='presentation'><a role='menuitem' tabindex='-1' href='#'>Something else here</a></li> "+
									"					<li role='presentation' class='divider'></li> "+
									"					<li role='presentation'><a role='menuitem' tabindex='-1' href='#'>Separated link</a></li> "+
									"				  </ul> "+
									"			</div> "+
									"			<span class='glyphicon glyphicon-user white-f8 pull-right' data-toggle='tooltip' "+
									"	data-original-title='Add more fiends to chat'></span> "+
									"		</div>		 "+
									"	</div> "+
									"	<div class='col-xs-12 chatBody'>	 "+
									"		<div class='col-xs-12 chatContent' id='"+chatNameId+"-chatContent'></div> "+
									"	</div> "+
									"	<div class='col-xs-12 chatFooter'> "+
									"		<textarea class='chatFooterText' id='"+chatNameId+"-Textarea'></textarea> "+
									"	</div> "+
									"  </div> ";
									
					$('.highlighted').removeClass('highlighted');
										
					if (chat.global.activeChatBoxesArray.length >= chat.global.maxNumberActiveChatBoxes ){
						chat.hideLastActiveChatBox();
					}
					
					chat.global.activeChatBoxesArray.push (chatNameId+'-chatBox');
					
					$('.hiddenChatBoxes0').before(chatBox);
					
					// Add all the listeners on the new Chat Box
					// If the user click the remove icon, remove the chatBox 
					$("#"+chatNameId+"-closeButton").click(function() {
						chat.closeActiveChatBox(chatNameId+'-chatBox');
					});	
					
					// If the user click the ChatBoxTitleBar, toggle or collapse the chatBox
					$('input[type="checkbox"]').click(function() {
						if (this.checked)
						  chat.collapseChatBox($(this).attr('rel'));
						else	
						  chat.expandChatBox($(this).attr('rel'));
					});	

					$('#'+chatNameId+'-Textarea').keypress(function(e) {
						if(e.which == 13) {
							processUserInput(chatApp, socket, $(this).attr('id'));
							return false;
						}				
					});	

					// Add the tooltip on the chatBox glyphicons
					$('.glyphicon').tooltip({placement: 'top'});						
				},
				hideLastActiveChatBox: function(){
					// Remove the chatBox from the activeChatBoxesArray
					var chatBoxId = chat.global.activeChatBoxesArray.pop();
					// Hide the chatBox
					$('#'+chatBoxId).addClass('hidden');
					// Add the chatBox to the hiddenChatBoxes List
					chat.addToHiddenList(chatBoxId);					
				},					
				addToHiddenList: function(chatBoxId){			
					// Add The chatBox in the hiddenChatBoxesArray
					chat.global.hiddenChatBoxesArray.push(chatBoxId);
					
					// Display the listHiddenChatBoxes
					$('.hiddenChatBoxes0').removeClass('hidden');
					
					// Add the chatBoxName in the listHiddenChatBoxes		
					var listHiddenChatBoxesItem = "<div class='listHiddenChatBoxesItem col-xs-12' id='"+chatBoxId+"-hiddenChatBoxesItem'> "+
														"<span class='col-xs-10'>"+$('#'+chatBoxId+' .titlebarText').text()+"</span><span class='glyphicon glyphicon-remove'></span>"+
												  "</div>";	 	
												  
					$('.listHiddenChatBoxes').prepend(listHiddenChatBoxesItem);	

					// Add the listeners on the new item
					$('#'+chatBoxId+'-hiddenChatBoxesItem').children('.glyphicon-remove').click(function() {	
						chat.closeHiddenChatBox(chatBoxId);
						chat.removeFromHiddenList(chatBoxId);					
					});	
					$('#'+chatBoxId+'-hiddenChatBoxesItem').click(function() {	
						chat.removeFromHiddenList(chatBoxId);
						chat.hideLastActiveChatBox();
						chat.addToActiveList(chatBoxId);
						chat.highlightChatBox(chatBoxId);						
					});					
					
					// Increase the counter of the number of hiddenChatBoxes					
					$('#hiddenChatBoxesCounter').html(chat.global.hiddenChatBoxesArray.length);					
				},
				removeFromHiddenList: function(chatBoxId){			
					// Remove the chatBox from hiddenChatBoxesArray
					for (var i=0 ; i < chat.global.hiddenChatBoxesArray.length ; ++i){
						if (chat.global.hiddenChatBoxesArray[i] == chatBoxId)
							 chat.global.hiddenChatBoxesArray.splice(i, 1);
					}
					
					// If hiddenChatBoxesArray is empty, hide the elmeent
					if (chat.global.hiddenChatBoxesArray.length == 0){
						$('.hiddenChatBoxes0').addClass('hidden');
						$('.listHiddenChatBoxes').addClass('hidden');	
						$('.numberHiddenChatBoxes').addClass('border-top-visible');						
					}
			
					// Remove the hiddenChatBoxesItem
					$('#'+chatBoxId+'-hiddenChatBoxesItem').remove();

					// Update the counter of the number of hiddenChatBoxes					
					$('#hiddenChatBoxesCounter').html(chat.global.hiddenChatBoxesArray.length);					
				},				
				addToActiveList: function(chatBoxId){
					// Add The chatBox in the hiddenChatBoxesArray
					chat.global.activeChatBoxesArray.push(chatBoxId);
					
					// Display the listHiddenChatBoxes
					$('#'+chatBoxId).removeClass('hidden');			
				},
				removeFromActiveList: function(chatBoxId){
					for (var i=0 ; i < chat.global.activeChatBoxesArray.length ; ++i){
						if (chat.global.activeChatBoxesArray[i] == chatBoxId){
							 chat.global.activeChatBoxesArray.splice(i, 1);
							 return i;
						}
					}				
				},
				closeActiveChatBox: function(chatBoxId){						
					var index = chat.removeFromActiveList(chatBoxId);
					
					if (chat.global.hiddenChatBoxesArray.length >= 1){
						
						var tmpChatBoxId = chat.global.hiddenChatBoxesArray[0];	
						chat.removeFromHiddenList(tmpChatBoxId);
						
						chat.global.activeChatBoxesArray.insert(index, tmpChatBoxId);
				
						$('#'+chatBoxId).after($("#"+tmpChatBoxId));
						
						$("#"+tmpChatBoxId).removeClass('hidden');					
					}
					$('#'+chatBoxId).remove();					
				},
				closeHiddenChatBox: function(chatBoxId){						
					$('#'+chatBoxId).remove();
					--chat.global.numberChatBoxes;	
				},				
				highlightChatBox: function(chatBoxId){
					$('.highlighted').removeClass('highlighted');
					$('#'+chatBoxId).children().children('.chatTitlebar').addClass('highlighted'); 
				},				
				collapseChatBox: function(chatNameId){
					$('#'+chatNameId+'-chatBox').children().children('.chatBody, .chatFooter').css('display','none');	
					$('#'+chatNameId+'-chatBox').removeClass('expanded');
					$('#'+chatNameId+'-chatBox').addClass('collapsed');
				},				
				expandChatBox: function(chatNameId){
					$('#'+chatNameId+'-chatBox').children().children('.chatBody, .chatFooter').css('display','block');	
					$('#'+chatNameId+'-chatBox').addClass('expanded');
					$('#'+chatNameId+'-chatBox').removeClass('collapsed');
					chat.highlightChatBox(chatNameId+'-chatBox');
				},			
				openChatBox: function(chatNameId){			
					if($('#'+chatNameId+'-chatBox').length == 0){
						// chatBox does not exist
						chat.createChatBox(chatNameId);
					}
					else if ($('#'+chatNameId+'-chatBox').hasClass('hidden')){
						chat.removeFromHiddenList(chatNameId+'-chatBox');
						chat.hideLastActiveChatBox();
						chat.addToActiveList(chatNameId+'-chatBox');
						chat.highlightChatBox(chatNameId+'-chatBox');						
					}	
					else if($('#'+chatNameId+'-chatBox').hasClass('expanded')){
						// chatBox exists and is expanded
						chat.highlightChatBox(chatNameId+'-chatBox');
					}	
					else{
						// chatBox exists and is collapsed
						chat.expandChatBox(chatNameId);
					}
				},
				hideUnhideListHiddenChatBoxes: function(){
					if ($('.listHiddenChatBoxes').hasClass('hidden')){
						$('.listHiddenChatBoxes').removeClass('hidden');
						$('.numberHiddenChatBoxes').removeClass('border-top-visible');
					}
					else{
						$('.listHiddenChatBoxes').addClass('hidden');
						$('.numberHiddenChatBoxes').addClass('border-top-visible');
					}
				},
			}
		})();
		
		$(function()
		{			
			var winHeight = $(window).height();
			var clicking = false;

			$('#sidebarGripper').mousedown(function(){
				clicking = true;
			});
			
			$(document).mouseup(function(){
				if(clicking == false)
					return;
				clicking = false;
				$('.feedsContainer.nano').nanoScroller();
				$(".feedsContainer.nano").nanoScroller({ flash: true });
				$(".chatContactsContainer.nano").nanoScroller();
				$(".chatContactsContainer.nano").nanoScroller({ flash: true });
			});

			$(document).mousemove(function(event){
				if(clicking == false) return;			
				$('.feedsContainer.nano').css('height',((event.clientY/winHeight)*100)+'%' );
				$('.chatContactsContainer.nano').css('height',(100-((event.clientY/winHeight))*100)+'%' );
			});			
			
			$(".feedsContainer.nano").nanoScroller(); 
			$(".chatContactsContainer.nano").nanoScroller();
					
			// If the user click a user name, open the corresponding chatBox
			$('.chatContactContainer').click(function() {	
				chat.openChatBox($(this).attr('id'));
			});	
			
			$('.numberHiddenChatBoxes').click(function() {	
				chat.hideUnhideListHiddenChatBoxes();	
			});	
		});
	</script>

    <!-- Include all compiled plugins (below), or include individual files as needed -->

  </body>
</html>